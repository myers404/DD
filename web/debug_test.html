<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPQ Configurator Debug Test</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .debug-section {
            margin: 2rem 0;
            padding: 1rem;
            background: #f5f5f5;
            border-radius: 8px;
        }

        .debug-section h2 {
            margin: 0 0 1rem;
            color: #333;
        }

        .log-output {
            background: #1e1e1e;
            color: #fff;
            padding: 1rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.875rem;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .test-buttons {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
        }

        button {
            padding: 0.5rem 1rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        button:hover {
            background: #2563eb;
        }

        #configurator {
            min-height: 600px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            margin-top: 2rem;
        }
    </style>
</head>
<body>
<h1>CPQ Configurator Debug Test</h1>

<div class="debug-section">
    <h2>Test Controls</h2>
    <div class="test-buttons">
        <button onclick="testModelLoad()">Test Model Load</button>
        <button onclick="inspectStore()">Inspect Store</button>
        <button onclick="clearLogs()">Clear Logs</button>
        <button onclick="reloadConfigurator()">Reload Configurator</button>
    </div>
</div>

<div class="debug-section">
    <h2>Console Output</h2>
    <div id="log-output" class="log-output"></div>
</div>

<div id="configurator"></div>

<script>
    // Capture console logs
    const logOutput = document.getElementById('log-output');
    const originalLog = console.log;
    const originalError = console.error;
    const originalWarn = console.warn;

    function addLog(type, ...args) {
        const timestamp = new Date().toLocaleTimeString();
        const message = args.map(arg =>
            typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
        ).join(' ');

        const color = type === 'error' ? '#ff6b6b' :
            type === 'warn' ? '#ffd93d' : '#4ecdc4';

        logOutput.innerHTML += `<div style="color: ${color}">[${timestamp}] ${type.toUpperCase()}: ${message}</div>\n`;
        logOutput.scrollTop = logOutput.scrollHeight;
    }

    console.log = function(...args) {
        originalLog.apply(console, args);
        addLog('log', ...args);
    };

    console.error = function(...args) {
        originalError.apply(console, args);
        addLog('error', ...args);
    };

    console.warn = function(...args) {
        originalWarn.apply(console, args);
        addLog('warn', ...args);
    };

    // Test functions
    function clearLogs() {
        logOutput.innerHTML = '';
    }

    async function testModelLoad() {
        console.log('Testing model load...');

        try {
            const response = await fetch('http://localhost:8080/api/v1/models/laptop-model-123');
            const data = await response.json();
            console.log('Model response:', data);

            // Test groups endpoint
            const groupsResponse = await fetch('http://localhost:8080/api/v1/models/laptop-model-123/groups');
            const groupsData = await groupsResponse.json();
            console.log('Groups response:', groupsData);

            // Test options endpoint
            const optionsResponse = await fetch('http://localhost:8080/api/v1/models/laptop-model-123/options');
            const optionsData = await optionsResponse.json();
            console.log('Options response:', optionsData);

        } catch (error) {
            console.error('Test failed:', error);
        }
    }

    function inspectStore() {
        if (window.widget && window.widget.store) {
            const store = window.widget.store;
            console.log('Store state:', {
                modelId: store.modelId,
                model: store.model,
                groups: store.groups,
                options: store.options,
                groupsIsArray: Array.isArray(store.groups),
                optionsIsArray: Array.isArray(store.options),
                groupsLength: store.groups?.length,
                optionsLength: store.options?.length,
                selections: store.selections,
                isLoading: store.isLoading,
                error: store.error
            });
        } else {
            console.warn('Widget not initialized yet');
        }
    }

    function reloadConfigurator() {
        if (window.widget) {
            window.widget.destroy();
        }

        console.log('Reloading configurator...');
        loadConfigurator();
    }

    // Load configurator
    let widget;

    function loadConfigurator() {
        // Wait for the widget script to load
        if (typeof CPQConfigurator === 'undefined') {
            console.error('CPQConfigurator not loaded. Include the widget script first.');
            return;
        }

        try {
            widget = CPQConfigurator.create('#configurator', {
                modelId: 'laptop-model-123',
                apiUrl: 'http://localhost:8080/api/v1',
                theme: 'light',
                onComplete: (config) => {
                    console.log('Configuration completed:', config);
                },
                onConfigurationChange: (config) => {
                    console.log('Configuration changed:', config);
                },
                onError: (error) => {
                    console.error('Configuration error:', error);
                }
            });

            window.widget = widget;
            console.log('Configurator loaded successfully');

        } catch (error) {
            console.error('Failed to load configurator:', error);
        }
    }

    // Load on page ready
    window.addEventListener('DOMContentLoaded', () => {
        console.log('Page loaded, initializing...');

        // Check if running locally
        if (window.location.protocol === 'file:') {
            addLog('warn', 'Running from file:// protocol. Make sure to run from a local server (e.g., npm run dev)');
        }

        // Try to load configurator after a short delay
        setTimeout(loadConfigurator, 100);
    });

    // Add global error handler
    window.addEventListener('error', (event) => {
        console.error('Global error:', event.error);
    });
</script>

<!-- Include the widget script -->
<script src="/dist-widget/cpq-widget.js"></script>
</body>
</html>